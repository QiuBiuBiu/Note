# 多线程冲突了怎么办？

## 竞争与协作
在**单核 CPU 系统里**，为了实现多个程序同时运行的假象，操作系统通常以时间片调度的方式，让每个进程执行每次执行一个时间片，时间片用完了，就切换下一个进程运行，由于这个时间片的时间很短，于是就造成了「**并发**」的现象。
- 如果一个程序只有一个执行流程，也代表它是单线程的。当然一个程序可以有多个执行流程，也就是所谓的多线程程序，线程是调度的基本单位，进程则是资源分配的基本单位。
- 线程之间是**可以共享进程的资源，比如代码段、堆空间、数据段、打开的文件等资源**，但每个线程都有自己独立的栈空间。那么问题就来了，多个线程如果竞争共享资源（比如全局变量），如果不采取有效的措施，则会造成共享数据的混乱。

### 互斥
1. 由于多线程执行操作共享变量的这段代码可能会导致竞争状态，因此我们将此段代码称为**临界区**（critical section），它是访问共享资源的代码片段，一定不能给多线程同时执行。
2. 我们希望这段代码是**互斥（mutualexclusion）的，也就说保证一个线程在临界区执行时，其他线程应该被阻止进入临界区**，说白了，就是这段代码执行过程中，最多只能出现一个线程。

### 同步
1. 我们都知道在多线程里，每个线程并不一定是顺序执行的，它们基本是以各自独立的、不可预知的速度向前推进，但有时候我们又希望**多个线程能密切合作，以实现一个共同的任务**。
2. 所谓同步，就是并发进程/线程在一些关键点上可能需要互相等待与互通消息，这种相互制约的等待与互通信息称为进程/线程同步。

## 互斥与同步的实现和使用
为了实现进程/线程间正确的协作，操作系统必须提供实现进程协作的措施和方法，主要的方法有两种：
1. 锁：加锁、解锁操作；
2. 信号量：P、V 操作；
这两个都可以方便地实现进程/线程互斥，而信号量比锁的功能更强一些，它还可以方便地实现进程/线程同步。

### 锁
使用加锁操作和解锁操作可以解决并发线程/进程的**互斥问题**。

#### 忙等待锁
- 当获取不到锁时，**线程就会一直 while 循环**，不做任何事情，所以就被称为「忙等待锁」，也被称为自旋锁（spin lock）。
- 这是最简单的一种锁，一直自旋，利用 CPU 周期，直到锁可用。**在单处理器上，需要抢占式的调度器（即不断通过时钟中断一个线程，运行其他线程）。否则，自旋锁在单 CPU 上无法使用，因为一个自旋的线程永远不会放弃 CPU**。

#### 无等待锁
无等待锁顾明思议就是获取不到锁的时候，不用自旋。既然不想自旋，那当没获取到锁的时候，就把当前线程放入到**锁的等待队列**，然后执行调度程序，把 CPU 让给其他线程执行。


### 信号量
信号量是操作系统提供的一种**协调共享资源访问的方法**。通常信号量表示资源的数量，对应的变量是一个整型（sem）变量。另外，还有两个原子操作的系统调用函数来控制信号量的，分别是：
1. P 操作：将 sem 减 1，相减后，如果 sem < 0，则进程/线程进入阻塞等待，否则继续，表明 P 操作可能会阻塞；
2. V 操作：将 sem 加 1，相加后，**如果 sem <= 0**，唤醒一个等待中的进程/线程，表明 V 操作不会阻塞；

#### PV 操作如何使用的呢？
- 信号量实现临界区的互斥访问：
    1. 为每类共享资源设置一个信号量 s，其初值为 1，表示该临界资源未被占用。
    2. 只要把进入临界区的操作置于 P(s) 和 V(s) 之间，即可实现进程/线程互斥
    3. 对于两个并发线程，互斥信号量的值仅取 1、0 和 -1 三个值，分别表示：
        - 如果互斥信号量为 1，表示没有线程进入临界区；
        - 如果互斥信号量为 0，表示有一个线程进入临界区；
        - 如果互斥信号量为 -1，表示一个线程进入临界区，另一个线程等待进入。
- 信号量实现事件同步
![Alt text](assets/19-%E4%BA%92%E6%96%A5%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0-%E5%90%83%E9%A5%AD%E4%BE%8B%E5%AD%90.webp)
- 生产者消费者问题
![Alt text](assets/21-%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B.webp)
- 哲学家就餐问题
![Alt text](assets/28-%E5%93%B2%E5%AD%A6%E5%AE%B6%E8%BF%9B%E9%A4%90-%E6%96%B9%E6%A1%88%E4%B8%89%E7%A4%BA%E4%BE%8B.webp)
- 读者-写者问题

